(window.webpackJsonp=window.webpackJsonp||[]).push([[110],{1083:function(t,e,o){"use strict";o.r(e);var n=o(642),r=o(7),c=(o(29),o(17),o(26),o(33),o(27),o(150),o(926),o(38),o(8),o(35),o(656),o(62),o(63),o(77),o(147),o(28),o(58),o(703),o(704),o(350),o(928)),l={props:{libraryItem:{type:Object,default:function(){}},playerOpen:Boolean,keepProgress:Boolean,fileId:String},data:function(){return{windowWidth:0,windowHeight:0,book:null,rendition:null,chapters:[],ereaderSettings:{theme:"dark",font:"serif",fontScale:100,lineSpacing:115,spread:"auto",textStroke:0}}},watch:{playerOpen:function(){this.resize()}},computed:{libraryItemId:function(){var t;return null===(t=this.libraryItem)||void 0===t?void 0:t.id},allowScriptedContent:function(){return this.$store.getters["libraries/getLibraryEpubsAllowScriptedContent"]},hasPrev:function(){var t;return!(null!==(t=this.rendition)&&void 0!==t&&null!==(t=t.location)&&void 0!==t&&t.atStart)},hasNext:function(){var t;return!(null!==(t=this.rendition)&&void 0!==t&&null!==(t=t.location)&&void 0!==t&&t.atEnd)},userMediaProgress:function(){if(this.libraryItemId)return this.$store.getters["user/getUserMediaProgress"](this.libraryItemId)},savedEbookLocation:function(){var t;return this.keepProgress&&null!==(t=this.userMediaProgress)&&void 0!==t&&t.ebookLocation&&String(this.userMediaProgress.ebookLocation).startsWith("epubcfi")?this.userMediaProgress.ebookLocation:null},localStorageLocationsKey:function(){return"ebookLocations-".concat(this.libraryItemId)},readerWidth:function(){return this.windowWidth<640?this.windowWidth:this.windowWidth-200},readerHeight:function(){return this.windowHeight<400||!this.playerOpen?this.windowHeight:this.windowHeight-164},ebookUrl:function(){return this.fileId?"/api/items/".concat(this.libraryItemId,"/ebook/").concat(this.fileId):"/api/items/".concat(this.libraryItemId,"/ebook")},themeRules:function(){var t=this.ereaderSettings.theme,e="dark"===t,o="sepia"===t,n=e?"#fff":o?"#5b4636":"#000",r=e?"rgb(35 35 35)":o?"rgb(244, 236, 216)":"rgb(255, 255, 255)",c=this.ereaderSettings.lineSpacing/100,l=this.ereaderSettings.fontScale/100,d=this.ereaderSettings.textStroke/100;return{"*":{color:"".concat(n,"!important"),"background-color":"".concat(r,"!important"),"line-height":"".concat(c*l,"rem!important"),"-webkit-text-stroke":"".concat(d,"px ").concat(n,"!important")},a:{color:"".concat(n,"!important")}}}},methods:{updateSettings:function(t){if(this.ereaderSettings=t,this.rendition){this.applyTheme();var e=t.fontScale||100;this.rendition.themes.fontSize("".concat(e,"%")),this.rendition.themes.font(t.font),this.rendition.spread(t.spread||"auto")}},prev:function(){var t,e;if(null!==(t=this.rendition)&&void 0!==t&&t.manager)return null===(e=this.rendition)||void 0===e?void 0:e.prev()},next:function(){var t,e;if(null!==(t=this.rendition)&&void 0!==t&&t.manager)return null===(e=this.rendition)||void 0===e?void 0:e.next()},goToChapter:function(t){var e,o;if(null!==(e=this.rendition)&&void 0!==e&&e.manager)return null===(o=this.rendition)||void 0===o?void 0:o.display(t)},findChapterFromPosition:function(t,e){for(var o,i=0;i<t.length;i++)if(e>=t[i].start&&(!t[i+1]||e<t[i+1].start)){if(o=t[i],t[i].subitems&&t[i].subitems.length>0)return this.findChapterFromPosition(t[i].subitems,e,o);break}return o},searchBook:function(t){var e=this;return Object(r.a)(regeneratorRuntime.mark((function o(){var r,c,l,d;return regeneratorRuntime.wrap((function(o){for(;;)switch(o.prev=o.next){case 0:return o.t0=structuredClone,o.next=3,e.chapters;case 3:return o.t1=o.sent,c=(0,o.t0)(o.t1),o.next=7,Promise.all(e.book.spine.spineItems.map((function(o){return o.load(e.book.load.bind(e.book)).then(o.find.bind(o,t)).finally(o.unload.bind(o))})));case 7:return l=o.sent,(r=[]).concat.apply(r,Object(n.a)(l)).forEach((function(t){t.start=e.book.locations.percentageFromCfi(t.cfi);var o=e.findChapterFromPosition(c,t.start);o&&o.searchResults.push(t)})),d=c.filter((function t(e){return!!e.searchResults.length||(e.subitems.length?(e.subitems=e.subitems.filter(t)).length:void 0)})),o.abrupt("return",d);case 12:case"end":return o.stop()}}),o)})))()},keyUp:function(t){var e="rtl"===this.book.package.metadata.direction;return 37==(t.keyCode||t.which)?e?this.next():this.prev():39==(t.keyCode||t.which)?e?this.prev():this.next():void 0},updateProgress:function(t){this.keepProgress&&this.$axios.$patch("/api/me/progress/".concat(this.libraryItemId),t,{progress:!1}).catch((function(t){console.error("EpubReader.updateProgress failed:",t)}))},getAllEbookLocationData:function(){var t=[],e=0;for(var o in localStorage)if(localStorage.hasOwnProperty(o)&&o.startsWith("ebookLocations-"))try{var n=JSON.parse(localStorage[o]);if(!n.locations)throw new Error("Invalid locations object");n.key=o,n.size=2*(localStorage[o].length+o.length),t.push(n),e+=n.size}catch(t){console.error("Failed to parse ebook locations",o,t),localStorage.removeItem(o)}return t.sort((function(a,b){return a.lastAccessed-b.lastAccessed})),{locations:t,totalSize:e}},checkSaveLocations:function(t){var e=3e6,o=2*JSON.stringify({lastAccessed:Date.now(),locations:t}).length;if(o>e)console.error("Epub locations are too large to store. Size =",o);else{for(var n=this.getAllEbookLocationData(),r=e-n.totalSize;r<o&&n.locations.length;){var c=n.locations.shift();console.log('Removing cached locations for epub "'.concat(c.key,'" taking up ').concat(c.size," bytes")),r+=c.size,localStorage.removeItem(c.key)}console.log('Cacheing epub locations with key "'.concat(this.localStorageLocationsKey,'" taking up ').concat(o," bytes")),this.saveLocations(t)}},saveLocations:function(t){localStorage.setItem(this.localStorageLocationsKey,JSON.stringify({lastAccessed:Date.now(),locations:t}))},loadLocations:function(){var t=localStorage.getItem(this.localStorageLocationsKey);if(!t)return null;var e=JSON.parse(t);return e.locations?(this.saveLocations(e.locations),e.locations):(console.error("Invalid epub locations stored",this.localStorageLocationsKey),localStorage.removeItem(this.localStorageLocationsKey),null)},relocated:function(t){this.savedEbookLocation!==t.start.cfi&&(t.end.percentage?this.updateProgress({ebookLocation:t.start.cfi,ebookProgress:t.end.percentage}):this.updateProgress({ebookLocation:t.start.cfi}))},initEpub:function(){var t=this,e=this,o=function(){var e=Object(r.a)(regeneratorRuntime.mark((function e(o){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.abrupt("return",t.$axios.$get(o,{responseType:"arraybuffer"}));case 4:throw e.prev=4,e.t0=e.catch(0),console.error("EpubReader.initEpub customRequest failed:",e.t0),e.t0;case 8:case"end":return e.stop()}}),e,null,[[0,4]])})));return function(t){return e.apply(this,arguments)}}();e.book=new c.a(e.ebookUrl,{width:this.readerWidth,height:this.readerHeight-50,openAs:"epub",requestMethod:o}),e.rendition=e.book.renderTo("viewer",{width:this.readerWidth,height:.8*this.readerHeight,allowScriptedContent:this.allowScriptedContent,spread:"auto",snap:!0,manager:"continuous",flow:"paginated"}),e.rendition.display(this.savedEbookLocation||e.book.locations.start),e.rendition.on("rendered",(function(){t.applyTheme()})),e.book.ready.then((function(){e.rendition.on("relocated",e.relocated),e.rendition.on("keydown",e.keyUp),e.rendition.on("touchstart",(function(e){t.$emit("touchstart",e)})),e.rendition.on("touchend",(function(e){t.$emit("touchend",e)}));var o=t.loadLocations();o?e.book.locations.load(o):e.book.locations.generate().then((function(){t.checkSaveLocations(e.book.locations.save())})),t.getChapters()})).catch((function(t){console.error("EpubReader.initEpub failed:",t)}))},getChapters:function(){var t,e=this,o=(null===(t=this.book)||void 0===t||null===(t=t.navigation)||void 0===t?void 0:t.toc)||[],n=[],c=this.book.packaging.navPath||this.book.packaging.ncxPath,l=function(){var t=Object(r.a)(regeneratorRuntime.mark((function t(o,n){var d;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return d=o.map(function(){var t=Object(r.a)(regeneratorRuntime.mark((function t(o,i){var r,d,h,f,v;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return m=o.href,base=void 0,base="https://example.invalid/",r=new URL(m,base+c).href.replace(base,""),d=r.split("#")[1],h=e.book.spine.get(r),t.next=5,h.load(e.book.load.bind(e.book));case 5:if(f=d?h.document.getElementById(d):h.document.body,v=h.cfiFromElement(f),n[i]={title:o.label.trim(),subitems:[],href:r,cfi:v,start:e.book.locations.percentageFromCfi(v),end:null,id:null,searchResults:[]},!o.subitems){t.next=11;break}return t.next=11,l(o.subitems,n[i].subitems);case 11:case"end":return t.stop()}var m,base}),t)})));return function(e,o){return t.apply(this,arguments)}}()),t.next=3,Promise.all(d);case 3:case"end":return t.stop()}}),t)})));return function(e,o){return t.apply(this,arguments)}}();return l(o,n).then((function(){e.chapters=n}))},flattenChapters:function(t){var e=function(t){return t.reduce((function(t,o){return o.subitems?[].concat(Object(n.a)(t),[o],Object(n.a)(e(o.subitems))):[].concat(Object(n.a)(t),[o])}),[])},o=e(t);o=o.sort((function(a,b){return a.start-b.start}));for(var i=0;i<o.length;i++)o[i].id=i,i<o.length-1?o[i].end=o[i+1].start:o[i].end=1;return o},resize:function(){var t;this.windowWidth=window.innerWidth,this.windowHeight=window.innerHeight,null===(t=this.rendition)||void 0===t||t.resize(this.readerWidth,.8*this.readerHeight)},applyTheme:function(){var t=this;this.rendition&&this.rendition.getContents().forEach((function(e){e.addStylesheetRules(t.themeRules)}))}},mounted:function(){this.windowWidth=window.innerWidth,this.windowHeight=window.innerHeight,window.addEventListener("resize",this.resize),this.initEpub()},beforeDestroy:function(){var t;window.removeEventListener("resize",this.resize),null===(t=this.book)||void 0===t||t.destroy()}},d=l,h=o(4),component=Object(h.a)(d,(function(){var t=this,e=t._self._c;return e("div",{staticClass:"h-full w-full",attrs:{id:"epub-reader"}},[e("div",{staticClass:"h-full flex items-center justify-center"},[e("button",{staticClass:"w-24 max-w-24 h-full hidden sm:flex items-center overflow-x-hidden justify-center opacity-50 hover:opacity-100",attrs:{type:"button","aria-label":"Previous page"}},[t.hasPrev?e("span",{staticClass:"material-symbols text-6xl",on:{mousedown:function(t){t.preventDefault()},click:t.prev}},[t._v("chevron_left")]):t._e()]),t._v(" "),t._m(0),t._v(" "),e("button",{staticClass:"w-24 max-w-24 h-full hidden sm:flex items-center justify-center overflow-x-hidden opacity-50 hover:opacity-100",attrs:{type:"button","aria-label":"Next page"}},[t.hasNext?e("span",{staticClass:"material-symbols text-6xl",on:{mousedown:function(t){t.preventDefault()},click:t.next}},[t._v("chevron_right")]):t._e()])])])}),[function(){var t=this._self._c;return t("div",{staticClass:"w-full",staticStyle:{height:"80%"},attrs:{id:"frame"}},[t("div",{attrs:{id:"viewer"}})])}],!1,null,null,null);e.default=component.exports}}]);