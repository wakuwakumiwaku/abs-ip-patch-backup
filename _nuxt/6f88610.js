(window.webpackJsonp=window.webpackJsonp||[]).push([[109],{1037:function(e,t,r){"use strict";r.r(t);var n=r(16),o=r(25),c=r(7),l=(r(29),r(17),r(26),r(22),r(33),r(41),r(27),r(57),r(150),r(14),r(44),r(45),r(38),r(8),r(35),r(159),r(77),r(28),r(40),r(188)),h=r.n(l);class d{constructor(e,t,path,r){this._name=e,this._size=t,this._path=path,this._archiveRef=r}get name(){return this._name}get size(){return this._size}extract(){return this._archiveRef.extractSingleFile(this._path)}}class f{static init(e={}){return f._options={workerUrl:"../dist/worker-bundle.js",...e},f._options}static open(e,t=null){t=t||f._options||f.init()&&console.warn("Automatically initializing using options: ",f._options);return new f(e,t).open()}constructor(e,t){this._worker=new Worker(t.workerUrl),this._worker.addEventListener("message",this._workerMsg.bind(this)),this._callbacks=[],this._content={},this._processed=0,this._file=e}async open(){return await this._postMessage({type:"HELLO"},((e,t,r)=>{"READY"===r.type&&e()})),await this._postMessage({type:"OPEN",file:this._file},((e,t,r)=>{"OPENED"===r.type&&e(this)}))}hasEncryptedData(){return this._postMessage({type:"CHECK_ENCRYPTION"},((e,t,r)=>{"ENCRYPTION_STATUS"===r.type&&e(r.status)}))}usePassword(e){return this._postMessage({type:"SET_PASSPHRASE",passphrase:e},((e,t,r)=>{"PASSPHRASE_STATUS"===r.type&&e(r.status)}))}getFilesObject(){return this._processed>0?Promise.resolve().then((()=>this._content)):this._postMessage({type:"LIST_FILES"},((e,t,r)=>{if("ENTRY"===r.type){const e=r.entry,[t,n]=this._getProp(this._content,e.path);return"FILE"===e.type&&(t[n]=new d(e.fileName,e.size,e.path,this)),!0}"END"===r.type&&(this._processed=1,e(this._cloneContent(this._content)))}))}getFilesArray(){return this.getFilesObject().then((e=>this._objectToArray(e)))}extractSingleFile(e){return this._postMessage({type:"EXTRACT_SINGLE_FILE",target:e},((e,t,r)=>{if("FILE"===r.type){e(new File([r.entry.fileData],r.entry.fileName,{type:"application/octet-stream"}))}}))}extractFiles(e){return this._processed>1?Promise.resolve().then((()=>this._content)):this._postMessage({type:"EXTRACT_FILES"},((t,r,n)=>{if("ENTRY"===n.type){const[t,r]=this._getProp(this._content,n.entry.path);return"FILE"===n.entry.type&&(t[r]=new File([n.entry.fileData],n.entry.fileName,{type:"application/octet-stream"}),void 0!==e&&setTimeout(e.bind(null,{file:t[r],path:n.entry.path}))),!0}"END"===n.type&&(this._processed=2,this._worker.terminate(),t(this._cloneContent(this._content)))}))}_cloneContent(e){if(e instanceof File||e instanceof d||null===e)return e;const t={};for(const r of Object.keys(e))t[r]=this._cloneContent(e[r]);return t}_objectToArray(e,path=""){const t=[];for(const r of Object.keys(e))e[r]instanceof File||e[r]instanceof d||null===e[r]?t.push({file:e[r]||r,path:path}):t.push(...this._objectToArray(e[r],`${path}${r}/`));return t}_getProp(e,path){const t=path.split("/");""===t[t.length-1]&&t.pop();let r=e,n=null;for(const e of t)r[e]=r[e]||{},n=r,r=r[e];return[n,t[t.length-1]]}_postMessage(e,t){return this._worker.postMessage(e),new Promise(((e,r)=>{this._callbacks.push(this._msgHandler.bind(this,t,e,r))}))}_msgHandler(e,t,r,n){if("BUSY"===n.type)r("worker is busy");else{if("ERROR"!==n.type)return e(t,r,n);r(n.error)}}_workerMsg({data:e}){(0,this._callbacks[this._callbacks.length-1])(e)||this._callbacks.pop()}}function m(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function v(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?m(Object(r),!0).forEach((function(t){Object(n.a)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):m(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}f.init({workerUrl:"/libarchive/worker-bundle.js"});var w={props:{libraryItem:{type:Object,default:function(){}},playerOpen:Boolean,keepProgress:Boolean,fileId:String},data:function(){return{loading:!1,pages:null,filesObject:null,mainImg:null,page:0,numPages:0,pageMenuWidth:256,showPageMenu:!1,showInfoMenu:!1,loadTimeout:null,loadedFirstPage:!1,comicMetadata:null,scale:80}},watch:{url:{immediate:!0,handler:function(){this.extract()}}},computed:{libraryItemId:function(){var e;return null===(e=this.libraryItem)||void 0===e?void 0:e.id},ebookUrl:function(){return this.fileId?"/api/items/".concat(this.libraryItemId,"/ebook/").concat(this.fileId):"/api/items/".concat(this.libraryItemId,"/ebook")},comicMetadataKeys:function(){return this.comicMetadata?Object.keys(this.comicMetadata):[]},canGoNext:function(){return this.page<this.numPages},canGoPrev:function(){return this.page>1},userMediaProgress:function(){if(this.libraryItemId)return this.$store.getters["user/getUserMediaProgress"](this.libraryItemId)},savedPage:function(){var e;return this.keepProgress?null===(e=this.userMediaProgress)||void 0===e||!e.ebookLocation||isNaN(this.userMediaProgress.ebookLocation)?0:Number(this.userMediaProgress.ebookLocation):0},cleanedPageNames:function(){var e;return(null===(e=this.pages)||void 0===e?void 0:e.map((function(p){if(p.length>50){var e=p.slice(0,22),t=p.slice(p.length-23);return"".concat(e," ... ").concat(t)}return p})))||[]},canScaleUp:function(){return this.scale<400},canScaleDown:function(){return this.scale>10}},methods:{clickShowPageMenu:function(){this.showInfoMenu=!1,this.showPageMenu=!this.showPageMenu},clickShowInfoMenu:function(){this.showPageMenu=!1,this.showInfoMenu=!this.showInfoMenu},updateProgress:function(){if(this.keepProgress)if(this.numPages){if(this.savedPage!==this.page){var e={ebookLocation:this.page,ebookProgress:Math.max(0,Math.min(1,(Number(this.page)-1)/Number(this.numPages)))};this.$axios.$patch("/api/me/progress/".concat(this.libraryItemId),e,{progress:!1}).catch((function(e){console.error("ComicReader.updateProgress failed:",e)}))}}else console.error("Num pages not loaded")},clickOutside:function(){this.showPageMenu&&(this.showPageMenu=!1),this.showInfoMenu&&(this.showInfoMenu=!1)},next:function(){this.canGoNext&&this.setPage(this.page+1)},prev:function(){this.canGoPrev&&this.setPage(this.page-1)},setPage:function(e){if(!(e<=0||e>this.numPages)){this.showPageMenu=!1,this.showInfoMenu=!1;var t=this.pages[e-1];return this.page=e,this.updateProgress(),this.extractFile(t)}},setLoadTimeout:function(){var e=this;this.loadTimeout=setTimeout((function(){e.loading=!0}),150)},extractFile:function(e){var t=this;return new Promise(function(){var r=Object(c.a)(regeneratorRuntime.mark((function r(n){var o,c;return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return t.setLoadTimeout(),r.next=3,t.filesObject[e].extract();case 3:o=r.sent,(c=new FileReader).onload=function(e){t.mainImg=e.target.result,t.loading=!1,n()},c.onerror=function(e){console.error(e),t.$toast.error("Read page file failed"),t.loading=!1,n()},c.readAsDataURL(o),clearTimeout(t.loadTimeout);case 9:case"end":return r.stop()}}),r)})));return function(e){return r.apply(this,arguments)}}())},extract:function(){var e=this;return Object(c.a)(regeneratorRuntime.mark((function t(){var r,n,o,c,l,d,m,v,w,y;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.loading=!0,t.next=3,e.$axios.$get(e.ebookUrl,{responseType:"blob"});case 3:return n=t.sent,t.next=6,f.open(n);case 6:return o=t.sent,t.next=9,o.getFilesObject();case 9:if(c=t.sent,e.filesObject=e.flattenFilesObject(c),console.log("Extracted files object",e.filesObject),l=Object.keys(e.filesObject),e.parseFilenames(l),!(d=l.find((function(e){return".xml"===(h.a.extname(e)||"").toLowerCase()})))){t.next=18;break}return t.next=18,e.extractXmlFile(d);case 18:if(e.numPages=e.pages.length,m=e.cleanedPageNames.map((function(p){return p})).sort((function(a,b){return a.length-b.length})).pop(),(v=document.createElement("p")).innerText=m,v.style.fontSize="0.875rem",v.style.opacity=0,v.style.position="absolute",document.body.appendChild(v),(w=null===(r=v.getBoundingClientRect())||void 0===r?void 0:r.width)&&(e.pageMenuWidth=w+28),v.remove(),!e.pages.length){t.next=37;break}return e.loading=!1,y=e.savedPage>0&&e.savedPage<=e.numPages?e.savedPage:1,t.next=34,e.setPage(y);case 34:e.loadedFirstPage=!0,t.next=39;break;case 37:e.$toast.error("Unable to extract pages"),e.loading=!1;case 39:case"end":return t.stop()}}),t)})))()},flattenFilesObject:function(e){var t=function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n={};for(var c in e){var l=r?r+"/"+c:c;e[c]instanceof d||c.startsWith("_")||"object"!==Object(o.a)(e[c])||Array.isArray(e[c])?n[l]=e[c]:n=v(v({},n),t(e[c],l))}return n};return t(e)},extractXmlFile:function(e){var t=this;return Object(c.a)(regeneratorRuntime.mark((function r(){var n,o;return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return console.log("extracting xml filename",e),r.prev=1,r.next=4,t.filesObject[e].extract();case 4:n=r.sent,(o=new FileReader).onload=function(e){t.comicMetadata=t.$xmlToJson(e.target.result),console.log("Metadata",t.comicMetadata)},o.onerror=function(e){console.error(e)},o.readAsText(n),r.next=14;break;case 11:r.prev=11,r.t0=r.catch(1),console.error(r.t0);case 14:case"end":return r.stop()}}),r,null,[[1,11]])})))()},parseImageFilename:function(e){var t=h.a.basename(e,h.a.extname(e)).match(/\d+/g);return null!=t&&t.length?{index:Number(t[t.length-1]),filename:e}:{index:-1,filename:e}},parseFilenames:function(e){var t=this,r=[".jpeg",".jpg",".png",".webp"],n=e.filter((function(e){return r.includes((h.a.extname(e)||"").toLowerCase())})).map((function(img){return t.parseImageFilename(img)})),o=n.filter((function(i){return i.index>=0})).sort((function(a,b){return a.index-b.index})).map((function(i){return i.filename})),c=n.filter((function(i){return i.index<0}));o=o.concat(c.map((function(i){return i.filename}))),this.pages=o},zoomIn:function(){this.scale+=10},zoomOut:function(){this.scale-=10},scroll:function(e){this.$refs.imageContainer.scrollBy({top:e.deltaY,left:e.deltaX,behavior:"auto"})}},mounted:function(){var e=this.$refs.prevButton,t=this.$refs.nextButton;e.addEventListener("wheel",this.scroll,{passive:!1}),t.addEventListener("wheel",this.scroll,{passive:!1})},beforeDestroy:function(){var e=this.$refs.prevButton,t=this.$refs.nextButton;e.removeEventListener("wheel",this.scroll,{passive:!1}),t.removeEventListener("wheel",this.scroll,{passive:!1})}},y=w,x=(r(924),r(4)),component=Object(x.a)(y,(function(){var e=this,t=e._self._c;return t("div",{staticClass:"w-full h-full"},[t("div",{directives:[{name:"show",rawName:"v-show",value:e.showPageMenu,expression:"showPageMenu"},{name:"click-outside",rawName:"v-click-outside",value:e.clickOutside,expression:"clickOutside"}],staticClass:"pagemenu absolute top-9 left-8 rounded-md overflow-y-auto bg-bg shadow-lg z-20 border border-gray-400",style:{width:e.pageMenuWidth+"px"}},e._l(e.cleanedPageNames,(function(r,n){return t("div",{key:r,staticClass:"w-full cursor-pointer hover:bg-black-200 px-2 py-1",class:e.page===n+1?"bg-black-200":"",on:{click:function(t){return e.setPage(n+1)}}},[t("p",{staticClass:"text-sm truncate"},[e._v(e._s(r))])])})),0),e._v(" "),t("div",{directives:[{name:"show",rawName:"v-show",value:e.showInfoMenu,expression:"showInfoMenu"},{name:"click-outside",rawName:"v-click-outside",value:e.clickOutside,expression:"clickOutside"}],staticClass:"pagemenu absolute top-9 left-20 rounded-md overflow-y-auto bg-bg shadow-lg z-20 border border-gray-400 w-96"},e._l(e.comicMetadataKeys,(function(r){return t("div",{key:r,staticClass:"w-full px-2 py-1"},[t("p",{staticClass:"text-xs"},[t("strong",[e._v(e._s(r))]),e._v(": "+e._s(e.comicMetadata[r])+"\n      ")])])})),0),e._v(" "),e.numPages?t("div",{staticClass:"absolute top-0 left-4 sm:left-8 bg-bg text-gray-100 border-b border-l border-r border-gray-400 hover:bg-black-200 cursor-pointer rounded-b-md w-10 h-9 flex items-center justify-center text-center z-20",on:{mousedown:function(e){e.preventDefault()},click:function(t){return t.stopPropagation(),t.preventDefault(),e.clickShowPageMenu.apply(null,arguments)}}},[t("span",{staticClass:"material-symbols text-xl"},[e._v("menu")])]):e._e(),e._v(" "),e.comicMetadata?t("div",{staticClass:"absolute top-0 left-16 sm:left-20 bg-bg text-gray-100 border-b border-l border-r border-gray-400 hover:bg-black-200 cursor-pointer rounded-b-md w-10 h-9 flex items-center justify-center text-center z-20",on:{mousedown:function(e){e.preventDefault()},click:function(t){return t.stopPropagation(),t.preventDefault(),e.clickShowInfoMenu.apply(null,arguments)}}},[t("span",{staticClass:"material-symbols text-xl"},[e._v("more")])]):e._e(),e._v(" "),e.pages&&e.numPages?t("a",{staticClass:"absolute top-0 bg-bg text-gray-100 border-b border-l border-r border-gray-400 hover:bg-black-200 cursor-pointer rounded-b-md w-10 h-9 flex items-center justify-center text-center z-20",class:e.comicMetadata?"left-28 sm:left-32":"left-16 sm:left-20",attrs:{href:e.mainImg,download:e.pages[e.page-1]}},[t("span",{staticClass:"material-symbols text-xl"},[e._v("download")])]):e._e(),e._v(" "),e.numPages?t("div",{staticClass:"absolute top-0 right-14 sm:right-16 bg-bg text-gray-100 border-b border-l border-r border-gray-400 rounded-b-md px-2 h-9 flex items-center text-center z-20"},[t("p",{staticClass:"font-mono"},[e._v(e._s(e.page)+" / "+e._s(e.numPages))])]):e._e(),e._v(" "),e.mainImg?t("div",{staticClass:"absolute top-0 right-36 sm:right-40 bg-bg text-gray-100 border-b border-l border-r border-gray-400 rounded-b-md px-2 h-9 flex items-center text-center z-20"},[t("ui-icon-btn",{staticClass:"mr-px",attrs:{icon:"zoom_out",size:8,disabled:!e.canScaleDown,borderless:""},on:{click:e.zoomOut}}),e._v(" "),t("ui-icon-btn",{staticClass:"ml-px",attrs:{icon:"zoom_in",size:8,disabled:!e.canScaleUp,borderless:""},on:{click:e.zoomIn}})],1):e._e(),e._v(" "),t("div",{staticClass:"w-full h-full relative"},[t("div",{directives:[{name:"show",rawName:"v-show",value:e.canGoPrev,expression:"canGoPrev"}],ref:"prevButton",staticClass:"absolute top-0 left-0 h-full w-1/2 lg:w-1/3 hover:opacity-100 opacity-0 z-10 cursor-pointer",on:{click:function(t){return t.stopPropagation(),t.preventDefault(),e.prev.apply(null,arguments)},mousedown:function(e){e.preventDefault()}}},[t("div",{staticClass:"flex items-center justify-center h-full w-1/2"},[t("span",{directives:[{name:"show",rawName:"v-show",value:e.loadedFirstPage,expression:"loadedFirstPage"}],staticClass:"material-symbols text-5xl text-white/30 cursor-pointer hover:text-white/90"},[e._v("arrow_back_ios")])])]),e._v(" "),t("div",{directives:[{name:"show",rawName:"v-show",value:e.canGoNext,expression:"canGoNext"}],ref:"nextButton",staticClass:"absolute top-0 right-0 h-full w-1/2 lg:w-1/3 hover:opacity-100 opacity-0 z-10 cursor-pointer",on:{click:function(t){return t.stopPropagation(),t.preventDefault(),e.next.apply(null,arguments)},mousedown:function(e){e.preventDefault()}}},[t("div",{staticClass:"flex items-center justify-center h-full w-1/2 ml-auto"},[t("span",{directives:[{name:"show",rawName:"v-show",value:e.loadedFirstPage,expression:"loadedFirstPage"}],staticClass:"material-symbols text-5xl text-white/30 cursor-pointer hover:text-white/90"},[e._v("arrow_forward_ios")])])]),e._v(" "),t("div",{ref:"imageContainer",staticClass:"w-full h-full relative overflow-auto"},[t("div",{staticClass:"h-full flex",class:e.scale>100?"":"justify-center"},[e.mainImg?t("img",{staticClass:"object-contain m-auto",style:{minWidth:e.scale+"%",width:e.scale+"%"},attrs:{src:e.mainImg}}):e._e()])]),e._v(" "),t("div",{directives:[{name:"show",rawName:"v-show",value:e.loading,expression:"loading"}],staticClass:"w-full h-full absolute top-0 left-0 flex items-center justify-center z-10"},[t("ui-loading-indicator")],1)])])}),[],!1,null,"8cb757b2",null);t.default=component.exports;installComponents(component,{UiIconBtn:r(148).default,UiLoadingIndicator:r(348).default})},808:function(e,t,r){var content=r(925);content.__esModule&&(content=content.default),"string"==typeof content&&(content=[[e.i,content,""]]),content.locals&&(e.exports=content.locals);(0,r(19).default)("23ca2a7c",content,!0,{sourceMap:!1})},924:function(e,t,r){"use strict";r(808)},925:function(e,t,r){var n=r(18)((function(i){return i[1]}));n.push([e.i,"\n.pagemenu[data-v-8cb757b2] {\n  max-height: calc(100% - 48px);\n}\n",""]),n.locals={},e.exports=n}}]);