(window.webpackJsonp=window.webpackJsonp||[]).push([[84,57,140],{1092:function(e,t,r){"use strict";r.r(t);var o=r(642),n=r(7),c=r(16);r(29),r(17),r(22),r(26),r(41),r(27),r(44),r(45),r(38),r(8),r(28),r(59),r(52),r(62),r(77),r(58),r(703),r(704),r(350);function l(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,o)}return r}var h={props:{processing:Boolean,libraryItem:{type:Object,default:function(){}}},data:function(){return{processingUpload:!1,searchTitle:null,searchAuthor:null,imageUrl:null,coversFound:[],hasSearched:!1,showLocalCovers:!1,previewUpload:null,selectedFile:null,provider:"google",currentSearchRequestId:null,searchInProgress:!1,socketListenersActive:!1}},watch:{libraryItem:{immediate:!0,handler:function(e){e&&this.init()}}},computed:{isProcessing:{get:function(){return this.processing},set:function(e){this.$emit("update:processing",e)}},providers:function(){return this.isPodcast?this.$store.state.scanners.podcastCoverProviders:this.$store.state.scanners.bookCoverProviders},searchTitleLabel:function(){return this.provider.startsWith("audible")?this.$strings.LabelSearchTitleOrASIN:"itunes"==this.provider?this.$strings.LabelSearchTerm:this.$strings.LabelSearchTitle},bookCoverAspectRatio:function(){return this.$store.getters["libraries/getBookCoverAspectRatio"]},libraryItemId:function(){var e;return(null===(e=this.libraryItem)||void 0===e?void 0:e.id)||null},libraryItemUpdatedAt:function(){var e;return(null===(e=this.libraryItem)||void 0===e?void 0:e.updatedAt)||null},mediaType:function(){var e;return(null===(e=this.libraryItem)||void 0===e?void 0:e.mediaType)||null},isPodcast:function(){return"podcast"==this.mediaType},media:function(){var e;return(null===(e=this.libraryItem)||void 0===e?void 0:e.media)||{}},coverPath:function(){return this.media.coverPath},coverUrl:function(){return this.coverPath?this.$store.getters["globals/getLibraryItemCoverSrcById"](this.libraryItemId,this.libraryItemUpdatedAt,!0):this.$store.getters["globals/getPlaceholderCoverSrc"]},mediaMetadata:function(){return this.media.metadata||{}},libraryFiles:function(){var e;return(null===(e=this.libraryItem)||void 0===e?void 0:e.libraryFiles)||[]},userCanUpload:function(){return this.$store.getters["user/getUserCanUpload"]},userCanDelete:function(){return this.$store.getters["user/getUserCanDelete"]},userToken:function(){return this.$store.getters["user/getToken"]},localCovers:function(){var e=this;return this.libraryFiles.filter((function(e){return"image"===e.fileType})).map((function(t){var r=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?l(Object(r),!0).forEach((function(t){Object(c.a)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):l(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}({},t);return r.localPath="".concat("/audiobookshelf","/api/items/").concat(e.libraryItemId,"/file/").concat(t.ino,"?token=").concat(e.userToken),r}))},socket:function(){return this.$root.socket}},methods:{submitCoverUpload:function(){var e=this;this.processingUpload=!0;var form=new FormData;form.set("cover",this.selectedFile),this.$axios.$post("/api/items/".concat(this.libraryItemId,"/cover"),form).then((function(data){data.error?e.$toast.error(data.error):e.resetCoverPreview(),e.processingUpload=!1})).catch((function(t){console.error("Failed",t),t.response&&t.response.data?e.$toast.error(t.response.data):e.$toast.error(e.$strings.ToastUnknownError),e.processingUpload=!1}))},resetCoverPreview:function(){this.$refs.fileInput&&this.$refs.fileInput.reset(),this.previewUpload=null,this.selectedFile=null},fileUploadSelected:function(e){this.previewUpload=URL.createObjectURL(e),this.selectedFile=e},init:function(){if(this.showLocalCovers=!1,!this.coversFound.length||this.searchTitle===this.mediaMetadata.title&&this.searchAuthor===this.mediaMetadata.authorName||(this.coversFound=[],this.hasSearched=!1),this.imageUrl="",this.searchTitle=this.mediaMetadata.title||"",this.searchAuthor=this.mediaMetadata.authorName||"",this.isPodcast)this.provider="itunes";else{var e="book-cover-provider-migrated",t=localStorage.getItem("book-cover-provider")||localStorage.getItem("book-provider")||"google";localStorage.getItem(e)||"all"!==t?this.provider=t:(localStorage.setItem("book-cover-provider","best"),localStorage.setItem(e,"true"),this.provider="best")}},removeCover:function(){var e=this;this.coverPath&&(this.isProcessing=!0,this.$axios.$delete("/api/items/".concat(this.libraryItemId,"/cover")).then((function(){})).catch((function(t){var r;console.error("Failed to remove cover",t),null!==(r=t.response)&&void 0!==r&&r.data&&e.$toast.error(t.response.data)})).finally((function(){e.isProcessing=!1})))},submitForm:function(){this.updateCover(this.imageUrl)},updateCover:function(e){var t=this;return Object(n.a)(regeneratorRuntime.mark((function r(){return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(e.startsWith("http:")||e.startsWith("https:")){r.next=3;break}return t.$toast.error(t.$strings.ToastInvalidUrl),r.abrupt("return");case 3:t.isProcessing=!0,t.$axios.$post("/api/items/".concat(t.libraryItemId,"/cover"),{url:e}).then((function(){t.imageUrl=""})).catch((function(e){var r;console.error("Failed to update cover",e),t.$toast.error((null===(r=e.response)||void 0===r?void 0:r.data)||t.$strings.ToastCoverUpdateFailed)})).finally((function(){t.isProcessing=!1}));case 5:case"end":return r.stop()}}),r)})))()},getSearchQuery:function(){var e="provider=".concat(this.provider,"&title=").concat(this.searchTitle);return this.searchAuthor&&(e+="&author=".concat(this.searchAuthor||"")),this.isPodcast&&(e+="&podcast=1"),e},persistProvider:function(){try{localStorage.setItem("book-cover-provider",this.provider)}catch(e){console.error("PersistProvider",e)}},generateRequestId:function(){return"cover-search-".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9))},addSocketListeners:function(){this.socket&&!this.socketListenersActive&&(this.socket.on("cover_search_result",this.handleSearchResult),this.socket.on("cover_search_complete",this.handleSearchComplete),this.socket.on("cover_search_error",this.handleSearchError),this.socket.on("cover_search_provider_error",this.handleProviderError),this.socket.on("cover_search_cancelled",this.handleSearchCancelled),this.socket.on("disconnect",this.handleSocketDisconnect),this.socketListenersActive=!0)},removeSocketListeners:function(){this.socket&&this.socketListenersActive&&(this.socket.off("cover_search_result",this.handleSearchResult),this.socket.off("cover_search_complete",this.handleSearchComplete),this.socket.off("cover_search_error",this.handleSearchError),this.socket.off("cover_search_provider_error",this.handleProviderError),this.socket.off("cover_search_cancelled",this.handleSearchCancelled),this.socket.off("disconnect",this.handleSocketDisconnect),this.socketListenersActive=!1)},handleSearchResult:function(data){var e,t=this;if(data.requestId===this.currentSearchRequestId){var r=data.covers.filter((function(e){return!t.coversFound.includes(e)}));(e=this.coversFound).push.apply(e,Object(o.a)(r))}},handleSearchComplete:function(data){data.requestId===this.currentSearchRequestId&&(this.searchInProgress=!1,this.currentSearchRequestId=null)},handleSearchError:function(data){data.requestId===this.currentSearchRequestId&&(console.error("[Cover Search] Search error:",data.error),this.$toast.error(this.$strings.ToastCoverSearchFailed),this.searchInProgress=!1,this.currentSearchRequestId=null)},handleProviderError:function(data){data.requestId===this.currentSearchRequestId&&console.warn("[Cover Search] Provider ".concat(data.provider," failed:"),data.error)},handleSearchCancelled:function(data){data.requestId===this.currentSearchRequestId&&(this.searchInProgress=!1,this.currentSearchRequestId=null)},handleSocketDisconnect:function(){this.searchInProgress&&this.currentSearchRequestId&&(this.searchInProgress=!1,this.currentSearchRequestId=null)},cancelCurrentSearch:function(){var e;if(!this.currentSearchRequestId||null===(e=this.socket)||void 0===e||!e.connected)return console.error("[Cover Search] Socket not connected"),void this.$toast.error(this.$strings.ToastConnectionNotAvailable);this.socket.emit("cancel_cover_search",this.currentSearchRequestId),this.currentSearchRequestId=null,this.searchInProgress=!1},submitSearchForm:function(){var e=this;return Object(n.a)(regeneratorRuntime.mark((function t(){var r,o;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(null!==(r=e.socket)&&void 0!==r&&r.connected){t.next=4;break}return console.error("[Cover Search] Socket not connected"),e.$toast.error(e.$strings.ToastConnectionNotAvailable),t.abrupt("return");case 4:e.searchInProgress&&e.cancelCurrentSearch(),e.persistProvider(),e.addSocketListeners(),e.coversFound=[],e.hasSearched=!0,e.searchInProgress=!0,o=e.generateRequestId(),e.currentSearchRequestId=o,e.socket.emit("search_covers",{requestId:o,title:e.searchTitle,author:e.searchAuthor||"",provider:e.provider,podcast:e.isPodcast});case 13:case"end":return t.stop()}}),t)})))()},setCover:function(e){var t=this;this.isProcessing=!0,this.$axios.$patch("/api/items/".concat(this.libraryItemId,"/cover"),{cover:e.metadata.path}).catch((function(e){var r;console.error("Failed to set local cover",e),t.$toast.error((null===(r=e.response)||void 0===r?void 0:r.data)||t.$strings.ToastCoverUpdateFailed)})).finally((function(){t.isProcessing=!1}))}},mounted:function(){this.addSocketListeners(),this.$store.dispatch("scanners/fetchProviders")},beforeDestroy:function(){this.searchInProgress&&this.cancelCurrentSearch(),this.removeSocketListeners()}},d=h,v=r(4),component=Object(v.a)(d,(function(){var e=this,t=e._self._c;return t("div",{staticClass:"w-full h-full overflow-hidden overflow-y-auto px-2 sm:px-4 py-6 relative"},[t("div",{staticClass:"flex flex-col sm:flex-row mb-4"},[t("div",{staticClass:"relative self-center md:self-start"},[t("covers-preview-cover",{attrs:{src:e.coverUrl,width:120,"book-cover-aspect-ratio":e.bookCoverAspectRatio}}),e._v(" "),e.media.coverPath?t("div",{staticClass:"absolute top-0 left-0 w-full h-full z-10 opacity-0 hover:opacity-100 transition-opacity duration-100"},[t("div",{staticClass:"absolute top-0 left-0 w-full h-16 bg-linear-to-b from-black-600 to-transparent"}),e._v(" "),e.userCanDelete?t("div",{staticClass:"p-1 absolute top-1 right-1 text-red-500 rounded-full w-8 h-8 cursor-pointer hover:text-red-400 shadow-xs",on:{click:e.removeCover}},[t("ui-tooltip",{attrs:{direction:"top",text:e.$strings.LabelRemoveCover}},[t("span",{staticClass:"material-symbols text-2xl"},[e._v("delete")])])],1):e._e()]):e._e()],1),e._v(" "),t("div",{staticClass:"grow sm:pl-2 md:pl-6 sm:pr-2 mt-6 md:mt-0"},[t("div",{staticClass:"flex items-center"},[e.userCanUpload?t("div",{staticClass:"w-10 md:w-40 pr-2 md:min-w-32"},[t("ui-file-input",{ref:"fileInput",on:{change:e.fileUploadSelected}},[t("span",{staticClass:"hidden md:inline-block"},[e._v(e._s(e.$strings.ButtonUploadCover))]),e._v(" "),t("span",{staticClass:"material-symbols text-2xl inline-block md:hidden!"},[e._v("upload")])])],1):e._e(),e._v(" "),t("form",{staticClass:"flex grow",on:{submit:function(t){return t.preventDefault(),e.submitForm.apply(null,arguments)}}},[t("ui-text-input",{staticClass:"h-9 w-full",attrs:{placeholder:e.$strings.LabelImageURLFromTheWeb},model:{value:e.imageUrl,callback:function(t){e.imageUrl=t},expression:"imageUrl"}}),e._v(" "),t("ui-btn",{staticClass:"ml-2 sm:ml-3 w-24 h-9",attrs:{color:"bg-success",type:"submit","padding-x":4,disabled:!e.imageUrl}},[e._v(e._s(e.$strings.ButtonSubmit))])],1)]),e._v(" "),e.localCovers.length?t("div",{staticClass:"mb-4 mt-6 border-t border-b border-white/10"},[t("div",{staticClass:"flex items-center justify-center py-2"},[t("p",[e._v(e._s(e.localCovers.length)+" local image"+e._s(1!==e.localCovers.length?"s":""))]),e._v(" "),t("div",{staticClass:"grow"}),e._v(" "),t("ui-btn",{attrs:{small:""},on:{click:function(t){e.showLocalCovers=!e.showLocalCovers}}},[e._v(e._s(e.showLocalCovers?e.$strings.ButtonHide:e.$strings.ButtonShow))])],1),e._v(" "),e.showLocalCovers?t("div",{staticClass:"flex items-center justify-center flex-wrap pb-2"},[e._l(e.localCovers,(function(r){return[t("div",{key:r.ino,staticClass:"m-0.5 mb-5 border-2 border-transparent hover:border-yellow-300 cursor-pointer",class:r.metadata.path===e.coverPath?"border-yellow-300":"",on:{click:function(t){return e.setCover(r)}}},[t("div",{staticClass:"h-24 bg-primary",style:{width:96/e.bookCoverAspectRatio+"px"}},[t("covers-preview-cover",{attrs:{src:r.localPath,width:96/e.bookCoverAspectRatio,"book-cover-aspect-ratio":e.bookCoverAspectRatio}})],1)])]}))],2):e._e()]):e._e()])]),e._v(" "),t("form",{on:{submit:function(t){return t.preventDefault(),e.submitSearchForm.apply(null,arguments)}}},[t("div",{staticClass:"flex flex-wrap sm:flex-nowrap items-center justify-start -mx-1"},[t("div",{staticClass:"w-48 grow p-1"},[t("ui-dropdown",{attrs:{items:e.providers,disabled:e.searchInProgress,label:e.$strings.LabelProvider,small:""},model:{value:e.provider,callback:function(t){e.provider=t},expression:"provider"}})],1),e._v(" "),t("div",{staticClass:"w-72 grow p-1"},[t("ui-text-input-with-label",{attrs:{disabled:e.searchInProgress,label:e.searchTitleLabel,placeholder:e.$strings.PlaceholderSearch},model:{value:e.searchTitle,callback:function(t){e.searchTitle=t},expression:"searchTitle"}})],1),e._v(" "),t("div",{directives:[{name:"show",rawName:"v-show",value:"itunes"!=e.provider&&"audiobookcovers"!=e.provider,expression:"provider != 'itunes' && provider != 'audiobookcovers'"}],staticClass:"w-72 grow p-1"},[t("ui-text-input-with-label",{attrs:{disabled:e.searchInProgress,label:e.$strings.LabelAuthor},model:{value:e.searchAuthor,callback:function(t){e.searchAuthor=t},expression:"searchAuthor"}})],1),e._v(" "),e.searchInProgress?t("ui-btn",{staticClass:"mt-5 ml-1 md:min-w-24",attrs:{"padding-x":4,type:"button",color:"bg-error"},on:{click:function(t){return t.preventDefault(),e.cancelCurrentSearch.apply(null,arguments)}}},[e._v(e._s(e.$strings.ButtonCancel))]):t("ui-btn",{staticClass:"mt-5 ml-1 md:min-w-24",attrs:{"padding-x":4,type:"submit"}},[e._v(e._s(e.$strings.ButtonSearch))])],1)]),e._v(" "),e.hasSearched?t("div",{staticClass:"flex items-center flex-wrap justify-center sm:max-h-80 sm:overflow-y-scroll mt-2 max-w-full"},[e.searchInProgress&&!e.coversFound.length?t("p",{staticClass:"text-gray-300 py-4"},[e._v(e._s(e.$strings.MessageLoading))]):e.searchInProgress||e.coversFound.length?e._e():t("p",{staticClass:"text-gray-300 py-4"},[e._v(e._s(e.$strings.MessageNoCoversFound))]),e._v(" "),e._l(e.coversFound,(function(r){return[t("div",{key:r,staticClass:"m-0.5 mb-5 border-2 border-transparent hover:border-yellow-300 cursor-pointer",class:r===e.coverPath?"border-yellow-300":"",on:{click:function(t){return e.updateCover(r)}}},[t("covers-preview-cover",{attrs:{src:r,width:80,"show-open-new-tab":"","book-cover-aspect-ratio":e.bookCoverAspectRatio}})],1)]}))],2):e._e(),e._v(" "),e.previewUpload?t("div",{staticClass:"absolute top-0 left-0 w-full h-full z-10 bg-bg p-8"},[t("p",{staticClass:"text-lg"},[e._v(e._s(e.$strings.HeaderPreviewCover))]),e._v(" "),t("span",{staticClass:"absolute top-4 right-4 material-symbols text-2xl cursor-pointer",on:{click:e.resetCoverPreview}},[e._v("close")]),e._v(" "),t("div",{staticClass:"flex justify-center py-4"},[t("covers-preview-cover",{attrs:{src:e.previewUpload,width:240,"book-cover-aspect-ratio":e.bookCoverAspectRatio}})],1),e._v(" "),t("div",{staticClass:"absolute bottom-0 right-0 flex py-4 px-5"},[t("ui-btn",{staticClass:"mx-2",attrs:{disabled:e.processingUpload},on:{click:e.resetCoverPreview}},[e._v(e._s(e.$strings.ButtonReset))]),e._v(" "),t("ui-btn",{attrs:{loading:e.processingUpload,color:"bg-success"},on:{click:e.submitCoverUpload}},[e._v(e._s(e.$strings.ButtonUpload))])],1)]):e._e()])}),[],!1,null,null,null);t.default=component.exports;installComponents(component,{CoversPreviewCover:r(356).default,UiTooltip:r(76).default,UiFileInput:r(685).default,UiTextInput:r(68).default,UiBtn:r(42).default,UiDropdown:r(236).default,UiTextInputWithLabel:r(121).default})},642:function(e,t,r){"use strict";r.d(t,"a",(function(){return l}));var o=r(183);var n=r(237),c=r(149);function l(e){return function(e){if(Array.isArray(e))return Object(o.a)(e)}(e)||Object(n.a)(e)||Object(c.a)(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}},685:function(e,t,r){"use strict";r.r(t);r(83),r(62);var o={props:{accept:{type:String,default:".png, .jpg, .jpeg, .webp"}},data:function(){return{}},computed:{},methods:{reset:function(){this.$refs.fileInput&&(this.$refs.fileInput.value="")},clickUpload:function(){this.$refs.fileInput&&this.$refs.fileInput.click()},inputChanged:function(e){if(e.target&&e.target.files){var t=Array.from(e.target.files);if(t&&t.length){var r=t[0];this.$emit("change",r)}}}},mounted:function(){}},n=r(4),component=Object(n.a)(o,(function(){var e=this,t=e._self._c;return t("div",[t("input",{ref:"fileInput",staticClass:"hidden",attrs:{type:"file",accept:e.accept},on:{change:e.inputChanged}}),e._v(" "),t("ui-btn",{staticClass:"hidden md:block w-full",attrs:{color:"bg-primary",type:"text"},on:{click:e.clickUpload}},[e._t("default")],2),e._v(" "),t("ui-icon-btn",{staticClass:"block md:hidden",attrs:{icon:"upload"},on:{click:e.clickUpload}})],1)}),[],!1,null,null,null);t.default=component.exports;installComponents(component,{UiBtn:r(42).default,UiIconBtn:r(148).default})}}]);